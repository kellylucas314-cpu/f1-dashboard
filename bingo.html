<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F1 Bingo 2026 üèéÔ∏è</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --red: #E8002D;
  --dark: #080808;
  --card-bg: #111;
  --cell-bg: #181818;
  --cell-hover: #222;
  --border: #2a2a2a;
  --text: #f0f0f0;
  --muted: #666;
  --gold: #FFD700;
  --green: #00C851;
  --free-bg: #0d2a0d;
  --free-color: #4dff4d;
  --marked: #E8002D;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--dark); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; }

.checker { height:6px; background:repeating-linear-gradient(90deg,#fff 0,#fff 14px,#000 14px,#000 28px); opacity:.1; }

/* TOP NAV */
.top-nav { display:flex; align-items:center; justify-content:space-between; padding:.6rem 1rem; border-bottom:1px solid var(--border); }
.back-link { font-family:'Orbitron',monospace; font-size:.6rem; color:var(--muted); text-decoration:none; letter-spacing:2px; }
.back-link:hover { color:var(--text); }
.nav-tabs { display:flex; gap:.25rem; }
.nav-tab { font-family:'Orbitron',monospace; font-size:.6rem; padding:.4rem .8rem; border-radius:4px; cursor:pointer; border:none; letter-spacing:1px; background:transparent; color:var(--muted); transition:all .15s; }
.nav-tab:hover { color:var(--text); background:#1a1a1a; }
.nav-tab.active { background:var(--red); color:#fff; }

/* HEADER */
header { text-align:center; padding:1.5rem 1rem .75rem; }
.title { font-family:'Orbitron',monospace; font-size:clamp(1.8rem,7vw,3.5rem); font-weight:900; background:linear-gradient(135deg,#fff,var(--red)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; letter-spacing:3px; }
.season-badge { display:inline-block; margin-top:.4rem; font-size:.65rem; font-family:'Orbitron',monospace; color:var(--muted); letter-spacing:3px; text-transform:uppercase; }

/* VIEWS */
.view { display:none; }
.view.active { display:block; }

/* ===== PLAY VIEW ===== */
.play-header { max-width:580px; margin:0 auto; padding:.75rem 1rem; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.card-name-input { flex:1; min-width:180px; background:#1a1a1a; border:1px solid #333; border-radius:6px; padding:.5rem .75rem; color:var(--text); font-family:'Orbitron',monospace; font-size:.8rem; letter-spacing:1px; outline:none; }
.card-name-input:focus { border-color:var(--red); }
.card-name-input::placeholder { color:var(--muted); }

.play-controls { display:flex; gap:.4rem; flex-wrap:wrap; justify-content:center; padding:0 1rem .75rem; max-width:580px; margin:0 auto; }
.btn { font-family:'Orbitron',monospace; font-size:.6rem; font-weight:700; letter-spacing:1px; padding:.5rem .9rem; border:none; border-radius:4px; cursor:pointer; transition:all .15s; white-space:nowrap; }
.btn-red { background:var(--red); color:#fff; }
.btn-red:hover { background:#ff1a44; }
.btn-dark { background:#222; color:var(--text); border:1px solid #333; }
.btn-dark:hover { background:#2a2a2a; }
.btn-ghost { background:transparent; color:var(--muted); border:1px solid #2a2a2a; }
.btn-ghost:hover { color:var(--text); border-color:#444; }
.btn-gold { background:var(--gold); color:#000; }
.btn-gold:hover { background:#ffdf20; }
.btn-green { background:#005a00; color:var(--green); border:1px solid #00a000; }
.btn-green:hover { background:#006a00; }

/* STATUS */
.status-bar { text-align:center; padding:.25rem 1rem .5rem; min-height:2rem; }
.status-txt { font-family:'Orbitron',monospace; font-size:.75rem; color:var(--muted); letter-spacing:1px; }
.status-txt.bingo { color:var(--gold); font-size:1.2rem; animation:flashB .5s ease-in-out infinite alternate; }
@keyframes flashB { from{opacity:1;transform:scale(1)} to{opacity:.7;transform:scale(1.05)} }

/* BOARD */
.board-wrap { display:flex; justify-content:center; padding:0 .5rem .75rem; }
.board { display:grid; grid-template-columns:repeat(5,1fr); gap:3px; width:100%; max-width:560px; background:#000; border:2px solid #222; border-radius:8px; padding:3px; }
.col-hdr { font-family:'Orbitron',monospace; font-size:1.2rem; font-weight:900; text-align:center; padding:.5rem 0; color:var(--red); background:#0d0d0d; border-radius:4px; }
.cell {
  aspect-ratio:1; background:var(--cell-bg); border-radius:4px;
  display:flex; align-items:center; justify-content:center;
  text-align:center; padding:.25rem; position:relative;
  font-size:clamp(.4rem,1.3vw,.6rem); font-weight:500; line-height:1.25;
  cursor:pointer; transition:all .15s; border:1px solid transparent;
  user-select:none; color:var(--text); word-break:break-word;
}
.cell:hover:not(.free-space):not(.editing) { background:var(--cell-hover); border-color:#444; }
.cell.marked { background:var(--marked) !important; color:#fff; font-weight:700; border-color:#ff4466; }
.cell.marked::after { content:''; position:absolute; inset:0; background:radial-gradient(circle,rgba(255,255,255,.12) 0%,transparent 70%); border-radius:4px; pointer-events:none; }
.cell.free-space { background:var(--free-bg) !important; border:1px solid #1a4a1a; color:var(--free-color); font-weight:700; cursor:default; font-size:clamp(.35rem,1.1vw,.55rem); }
.cell.bingo-line { background:var(--gold) !important; color:#000 !important; font-weight:700; animation:pulseCell .6s ease-in-out infinite alternate; }
@keyframes pulseCell { from{transform:scale(1)} to{transform:scale(1.04)} }

/* Edit overlay on cell */
.cell .edit-btn {
  display:none; position:absolute; top:2px; right:2px;
  background:rgba(0,0,0,.7); border:none; border-radius:3px;
  color:#aaa; font-size:.55rem; padding:1px 3px; cursor:pointer; line-height:1;
  z-index:2;
}
.cell:hover .edit-btn { display:block; }
.cell.free-space .edit-btn { display:none !important; }
.cell.marked .edit-btn { color:rgba(255,255,255,.6); background:rgba(0,0,0,.4); }
.cell.editing { background:#1a1a2e !important; border-color:#4466ff !important; cursor:default; padding:.15rem; }
.cell.editing .edit-btn { display:none; }
.cell textarea {
  width:100%; height:100%; background:transparent; border:none;
  color:#fff; font-size:clamp(.4rem,1.3vw,.6rem); font-family:'Inter',sans-serif;
  font-weight:500; text-align:center; resize:none; outline:none; line-height:1.3;
}

/* Marked count */
.marked-count { text-align:center; color:var(--muted); font-size:.7rem; padding:.2rem; letter-spacing:1px; }

/* POOL SECTION */
.pool-section { max-width:560px; margin:.5rem auto 1rem; padding:0 .75rem; }
.pool-title { font-family:'Orbitron',monospace; font-size:.6rem; color:var(--muted); letter-spacing:2px; margin-bottom:.4rem; display:flex; align-items:center; gap:.5rem; }
.pool-add { display:flex; gap:.4rem; margin-bottom:.6rem; }
.pool-input { flex:1; background:#1a1a1a; border:1px solid #333; border-radius:4px; padding:.4rem .6rem; color:var(--text); font-size:.7rem; outline:none; }
.pool-input:focus { border-color:var(--red); }
.pool-grid { display:flex; flex-wrap:wrap; gap:.3rem; }
.pool-tag { font-size:.6rem; padding:.2rem .5rem; background:#151515; border:1px solid #2a2a2a; border-radius:3px; color:var(--muted); cursor:pointer; transition:all .15s; }
.pool-tag:hover { border-color:var(--red); color:var(--text); }
.pool-tag.custom-tag { border-color:#333; color:#aaa; }
.pool-tag .rm { margin-left:.3rem; color:#444; }
.pool-tag:hover .rm { color:var(--red); }

/* Share toast */
.toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%); background:#222; border:1px solid #444; border-radius:6px; padding:.6rem 1.2rem; font-size:.75rem; font-family:'Orbitron',monospace; letter-spacing:1px; color:var(--text); opacity:0; transition:opacity .3s; pointer-events:none; z-index:100; }
.toast.show { opacity:1; }

/* ===== CARDS VIEW ===== */
.cards-view { max-width:640px; margin:0 auto; padding:1rem; }
.cards-title { font-family:'Orbitron',monospace; font-size:.8rem; color:var(--muted); letter-spacing:2px; margin-bottom:1rem; }
.cards-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.75rem; }
.saved-card {
  background:#111; border:1px solid #2a2a2a; border-radius:8px;
  padding:1rem; cursor:pointer; transition:all .2s; position:relative;
}
.saved-card:hover { border-color:var(--red); transform:translateY(-2px); }
.saved-card-name { font-family:'Orbitron',monospace; font-size:.75rem; font-weight:700; color:var(--text); margin-bottom:.4rem; }
.saved-card-meta { font-size:.65rem; color:var(--muted); margin-bottom:.6rem; }
.saved-card-preview { display:grid; grid-template-columns:repeat(5,1fr); gap:2px; margin-bottom:.6rem; }
.preview-cell { aspect-ratio:1; border-radius:2px; background:#1a1a1a; }
.preview-cell.pm { background:var(--red); }
.preview-cell.pf { background:#1a3a1a; }
.saved-card-btns { display:flex; gap:.3rem; flex-wrap:wrap; }
.sc-btn { font-size:.55rem; font-family:'Orbitron',monospace; padding:.25rem .5rem; border-radius:3px; border:none; cursor:pointer; letter-spacing:.5px; }
.sc-btn-load { background:var(--red); color:#fff; }
.sc-btn-del { background:#222; color:var(--muted); border:1px solid #333; }
.sc-btn-share { background:#1a1a1a; color:#aaa; border:1px solid #333; }
.empty-state { text-align:center; color:var(--muted); padding:3rem 1rem; font-size:.8rem; letter-spacing:1px; }

/* Confetti */
.confetti-wrap { position:fixed; top:0;left:0;width:100%;height:100%; pointer-events:none; z-index:999; overflow:hidden; }
.cp { position:absolute; top:-10px; animation:cFall linear forwards; border-radius:50%; }
@keyframes cFall { to { transform:translateY(110vh) rotate(720deg); opacity:0; } }

footer { text-align:center; padding:1.5rem; color:#2a2a2a; font-size:.65rem; letter-spacing:1px; }
</style>
</head>
<body>

<div class="checker"></div>
<div class="confetti-wrap" id="confettiWrap"></div>
<div class="toast" id="toast">üìã Link copied to clipboard!</div>

<!-- TOP NAV -->
<div class="top-nav">
  <a href="index.html" class="back-link">‚Üê F1 Dashboard</a>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('play')">üé∞ Play</button>
    <button class="nav-tab" onclick="switchView('cards')">üìã All Cards</button>
  </div>
</div>

<header>
  <div class="title">F1 BINGO</div>
  <div class="season-badge">2026 Season ¬∑ Active Aero Era</div>
</header>

<!-- ===== PLAY VIEW ===== -->
<div id="view-play" class="view active">
  <div class="play-header">
    <input class="card-name-input" id="cardName" type="text" placeholder="Name your card (e.g. Kelly's Card)" maxlength="40">
  </div>
  <div class="play-controls">
    <button class="btn btn-red" onclick="randomizeCard()">üîÄ New Random Card</button>
    <button class="btn btn-dark" onclick="loadKellysCard()">üì∏ Kelly's Card</button>
    <button class="btn btn-green" onclick="saveCard()">üíæ Save Card</button>
    <button class="btn btn-gold" onclick="shareCard()">üîó Share Link</button>
    <button class="btn btn-ghost" onclick="resetMarks()">‚Ü∫ Reset Marks</button>
  </div>
  <div class="status-bar"><div class="status-txt" id="statusTxt">Click squares as they happen ¬∑ Double-tap to edit any square ‚úèÔ∏è</div></div>
  <div class="board-wrap">
    <div class="board" id="board">
      <div class="col-hdr">B</div><div class="col-hdr">I</div><div class="col-hdr">N</div><div class="col-hdr">G</div><div class="col-hdr">O</div>
    </div>
  </div>
  <div class="marked-count" id="markedCount"></div>

  <!-- Pool -->
  <div class="pool-section">
    <div class="pool-title">üìã 2026 Regs Square Pool ¬∑ click to add to card</div>
    <div class="pool-add">
      <input class="pool-input" id="customPoolInput" type="text" placeholder="Add your own square idea..." maxlength="60">
      <button class="btn btn-dark" onclick="addCustomToPool()">+ Add</button>
    </div>
    <div class="pool-grid" id="poolGrid"></div>
  </div>
</div>

<!-- ===== CARDS VIEW ===== -->
<div id="view-cards" class="view">
  <div class="cards-view">
    <div class="cards-title">SAVED CARDS</div>
    <div class="cards-grid" id="cardsGrid"></div>
  </div>
</div>

<footer>F1 Bingo 2026 ¬∑ Made by Kip ü¶â ¬∑ Share with your race day crew</footer>

<script>
// =====================
//   DATA
// =====================

const KELLYS_CARD = [
  "Lando Says\nSomething\nObnoxious\nin the Press",
  "Charles\nRace Win",
  "Cristian\nHorner\nSpotted\nin Paddock",
  "Ferrari\nBlows\nStrategy",
  "Max/GP Radio\nFight",

  "Team\nDouble\nDNF",
  "Ollie\nBearman\nPodium",
  "Lando\nBlows\nA Start",
  "Max +\nGeorge\nCrash",
  "Papaya\nRules\nF*cks\nOscar",

  "Bernie\nEcclestone\nDies",
  "Photoshoot:\nCharles\nLooking Sad",
  "FREE:\nMax Wins\nA Race",
  "Lewis\nPodium",
  "Checo\nTop 5\nFinish",

  "McLaren\nStrategy\nF*ck Up",
  "George\nTalks Sh*t\nAbout Max\nin Press",
  "Lance Stroll\nOut-Qualifies\nFernando",
  "George\nWins\n5 Races",
  "Alonso\nTop 5\nFinish",

  "Charles\nDNF üò≠",
  "Max\n5x WDC",
  "Kimi\nTakes\nSomeone\nOut (DNF)",
  "Max Talks\nSh*t About\nFIA",
  "Carlos\nPodium",
];

const KELLYS_FREE = [12];

// 2026-era pool
const BASE_POOL = [
  // 2026 regs specific
  "Driver Complains\nAbout the\nNew Regs",
  "Mercedes\nEngine\nDeclared\nIllegal",
  "Someone New\nin the\nEpstein Files",
  "Active Aero\nMalfunction\non Track",
  "Active Aero\nControversy\n(Was It Legal?)",
  "New Power Unit\nFailure DNF",
  "Car Underweight\nDQ",
  "Budget Cap\nBreach Fine",
  "Rookie Causes\nSafety Car",
  "Antonelli\nCrash",
  "Bearman\nImpresses",
  "Doohan Gets\nDropped",
  "Hamilton Proves\nFerrari Right",
  "Hamilton Regrets\nLeaving Mercedes",
  "Audi/Sauber\nChaos",
  "Aston Martin\nNo Points\nWeekend",
  "Alpine\nMeltdown",
  "Williams\nSurprise\nPodium",
  // Classics
  "0 DNF\nRace",
  "Last Corner\nOvertake",
  "Black Flag",
  "Triple Crown\nWeekend",
  "Engine\non Fire",
  "Home Win\nRace",
  "Unexpected\nPodium",
  "Botched\nPitstop",
  "Reserve\nDriver Races",
  "Rookie\nWins Race",
  "Teammates\nCollide",
  "Mid-Season\nDriver Swap",
  "Team Order\nControversy",
  "First Time\nRace Winner",
  "10 Second\nPenalty",
  "Red Flag\nStops Race",
  "Risky Strategy\nPays Off",
  "Risky Strategy\nRuins Race",
  "Grand Prix\nPostponed",
  "3+ Cars Crash\non Lap 1",
  "Mid-Race\nRain Storm",
  "Car Loses\nWheel",
  "Sub 2 Second\nPit Stop",
  "Swear Words\nPenalty",
  "Podium Lost\nDue to Penalty",
  "Loss of\nFront Wing",
  "Driver Has\nNo Water",
  "Animal\non Track",
  "Safety Car\nRuins Leader",
  "VSC at\nWorst Moment",
  "F1 TV Cuts\nAway at\nWorst Time",
  "Commentator\nSays Something\nEmbarrassing",
  "Fastest Lap\nBattle Last Lap",
  "Hamilton on\nRadio Being\nDramatic",
  "Lando Cries\nOn Podium",
  "Max Calls\nEngineer\nDumb",
  "Norris\nClose But\nNo Cigar",
  "Stewards Make\nControversial\nDecision",
  "Grid Girl\nMoment Goes\nViral",
  "Pit Lane\nSpeed Penalty",
  "Two Safety\nCars Same\nRace",
];

// =====================
//   STATE
// =====================

let currentSquares = [...KELLYS_CARD];
let freeIdx = [...KELLYS_FREE];
let markedCells = new Set();
let editingIdx = null;
let customPool = JSON.parse(localStorage.getItem('f1bingo_custompool') || '[]');

// =====================
//   INIT
// =====================

window.addEventListener('DOMContentLoaded', () => {
  // Check for shared card in URL hash
  const hash = window.location.hash.slice(1);
  if (hash.startsWith('card=')) {
    try {
      const decoded = JSON.parse(atob(hash.slice(5)));
      currentSquares = decoded.squares;
      freeIdx = decoded.freeIdx || [12];
      document.getElementById('cardName').value = decoded.name ? `${decoded.name} (copy)` : '';
    } catch(e) { loadKellysCard(); }
  } else {
    loadKellysCard();
  }
  renderPool();
  renderBoard();
});

// =====================
//   VIEWS
// =====================

function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  event.target.classList.add('active');
  if (name === 'cards') renderCardsGallery();
}

// =====================
//   BOARD
// =====================

function renderBoard() {
  const board = document.getElementById('board');
  board.innerHTML = `
    <div class="col-hdr">B</div><div class="col-hdr">I</div>
    <div class="col-hdr">N</div><div class="col-hdr">G</div><div class="col-hdr">O</div>
  `;
  currentSquares.forEach((text, i) => {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.idx = i;

    const isFree = freeIdx.includes(i);
    const isMarked = markedCells.has(i) || isFree;

    if (isFree) cell.classList.add('free-space');
    if (isMarked && !isFree) cell.classList.add('marked');

    // Display text
    const span = document.createElement('span');
    span.style.whiteSpace = 'pre-line';
    span.textContent = text;
    cell.appendChild(span);

    // Edit button (pencil)
    if (!isFree) {
      const editBtn = document.createElement('button');
      editBtn.className = 'edit-btn';
      editBtn.innerHTML = '‚úèÔ∏è';
      editBtn.title = 'Edit this square';
      editBtn.addEventListener('click', (e) => { e.stopPropagation(); startEdit(i, cell); });
      cell.appendChild(editBtn);
    }

    // Click to mark
    cell.addEventListener('click', () => {
      if (isFree || editingIdx === i) return;
      if (markedCells.has(i)) markedCells.delete(i);
      else markedCells.add(i);
      renderBoard();
      checkBingo();
      updateCount();
    });

    board.appendChild(cell);
  });
  checkBingo();
  updateCount();
}

function startEdit(idx, cell) {
  if (editingIdx !== null) finishEdit(editingIdx);
  editingIdx = idx;
  cell.classList.add('editing');
  cell.querySelector('span').style.display = 'none';
  const btn = cell.querySelector('.edit-btn');
  if (btn) btn.style.display = 'none';

  const ta = document.createElement('textarea');
  ta.value = currentSquares[idx];
  ta.placeholder = 'Enter square text...';
  cell.appendChild(ta);
  ta.focus();
  ta.select();

  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); finishEdit(idx); }
    if (e.key === 'Escape') { ta.value = currentSquares[idx]; finishEdit(idx); }
  });
  ta.addEventListener('blur', () => setTimeout(() => finishEdit(idx), 100));
}

function finishEdit(idx) {
  const cell = document.querySelector(`.cell[data-idx="${idx}"]`);
  if (!cell) { editingIdx = null; return; }
  const ta = cell.querySelector('textarea');
  if (ta && ta.value.trim()) currentSquares[idx] = ta.value.trim();
  editingIdx = null;
  renderBoard();
}

function randomizeCell(idx) {
  const allSquares = [...BASE_POOL, ...customPool];
  const unused = allSquares.filter(s => !currentSquares.includes(s));
  const pool = unused.length > 0 ? unused : allSquares;
  currentSquares[idx] = pool[Math.floor(Math.random() * pool.length)];
  markedCells.delete(idx);
  renderBoard();
}

// =====================
//   GAME LOGIC
// =====================

function getMarked() {
  const s = new Set(markedCells);
  freeIdx.forEach(i => s.add(i));
  return s;
}

function checkBingo() {
  const marked = getMarked();
  const lines = [];
  for (let r=0;r<5;r++) { const l=[r*5,r*5+1,r*5+2,r*5+3,r*5+4]; if(l.every(i=>marked.has(i))) lines.push(l); }
  for (let c=0;c<5;c++) { const l=[c,c+5,c+10,c+15,c+20]; if(l.every(i=>marked.has(i))) lines.push(l); }
  if([0,6,12,18,24].every(i=>marked.has(i))) lines.push([0,6,12,18,24]);
  if([4,8,12,16,20].every(i=>marked.has(i))) lines.push([4,8,12,16,20]);

  const cells = document.querySelectorAll('.cell');
  cells.forEach(c => c.classList.remove('bingo-line'));

  const statusEl = document.getElementById('statusTxt');
  if (lines.length > 0) {
    statusEl.className = 'status-txt bingo';
    statusEl.textContent = `üèÜ BINGO! ${lines.length} line${lines.length>1?'s':''}! üèÜ`;
    const allCells = Array.from(cells);
    lines.flat().forEach(i => { if(allCells[i]) allCells[i].classList.add('bingo-line'); });
    launchConfetti();
  } else {
    statusEl.className = 'status-txt';
    const count = getMarked().size;
    statusEl.textContent = count >= 5 ? `${count} squares marked ‚Äî keep going! üèéÔ∏è` : 'Click squares as they happen ¬∑ ‚úèÔ∏è to edit any square';
  }
}

function updateCount() {
  const n = getMarked().size;
  document.getElementById('markedCount').textContent = `${n} / 25 squares marked`;
}

function resetMarks() {
  markedCells.clear();
  renderBoard();
}

// =====================
//   CARD MANAGEMENT
// =====================

function loadKellysCard() {
  currentSquares = [...KELLYS_CARD];
  freeIdx = [...KELLYS_FREE];
  markedCells.clear();
  const input = document.getElementById('cardName');
  if (!input.value) input.value = "Kelly's Card";
  renderBoard();
}

function randomizeCard() {
  const all = [...BASE_POOL, ...customPool];
  const shuffled = [...all].sort(() => Math.random() - 0.5);
  // 2026 must-haves
  const mustHaves = ["Driver Complains\nAbout the\nNew Regs", "Active Aero\nMalfunction\non Track"];
  const card = [];
  let pi = 0;
  for (let i=0;i<25;i++) {
    if (i === 12) { card.push('FREE:\nMax Wins\nA Race'); continue; }
    if (i < mustHaves.length) { card.push(mustHaves[i]); continue; }
    while (pi < shuffled.length && (card.includes(shuffled[pi]) || mustHaves.includes(shuffled[pi]))) pi++;
    card.push(shuffled[pi] || `Square ${i+1}`);
    pi++;
  }
  currentSquares = card;
  freeIdx = [12];
  markedCells.clear();
  document.getElementById('cardName').value = '';
  renderBoard();
}

function saveCard() {
  const name = document.getElementById('cardName').value.trim() || `Card ${Date.now()}`;
  const cards = JSON.parse(localStorage.getItem('f1bingo_cards') || '[]');
  const id = `card_${Date.now()}`;
  const marked = [...markedCells];
  cards.unshift({ id, name, squares: [...currentSquares], freeIdx: [...freeIdx], marked, savedAt: new Date().toISOString() });
  localStorage.setItem('f1bingo_cards', JSON.stringify(cards));
  showToast(`üíæ "${name}" saved!`);
}

function shareCard() {
  const name = document.getElementById('cardName').value.trim() || 'F1 Bingo Card';
  const payload = { name, squares: currentSquares, freeIdx };
  const encoded = btoa(JSON.stringify(payload));
  const url = `${window.location.origin}${window.location.pathname}#card=${encoded}`;
  navigator.clipboard.writeText(url).then(() => showToast('üîó Share link copied!')).catch(() => {
    prompt('Copy this link:', url);
  });
}

// =====================
//   POOL
// =====================

function renderPool() {
  const grid = document.getElementById('poolGrid');
  grid.innerHTML = '';
  const allSquares = [...BASE_POOL, ...customPool];
  allSquares.forEach((text, idx) => {
    const tag = document.createElement('div');
    const isCustom = idx >= BASE_POOL.length;
    tag.className = `pool-tag${isCustom?' custom-tag':''}`;
    const label = text.replace(/\n/g, ' ');
    tag.innerHTML = `${label}${isCustom?`<span class="rm" onclick="removeCustom(${idx-BASE_POOL.length},event)">‚úï</span>`:''}`;
    tag.addEventListener('click', (e) => {
      if (e.target.classList.contains('rm')) return;
      addToCard(text);
    });
    grid.appendChild(tag);
  });
}

function addToCard(text) {
  // Replace first non-free, non-marked cell
  const firstEmpty = currentSquares.findIndex((_, i) => !freeIdx.includes(i) && !markedCells.has(i));
  if (firstEmpty === -1) { showToast('Card is full ‚Äî reset marks first!'); return; }
  // Better: replace a random unmarked cell
  const candidates = currentSquares.map((_,i)=>i).filter(i => !freeIdx.includes(i) && !markedCells.has(i));
  const pick = candidates[Math.floor(Math.random() * candidates.length)];
  currentSquares[pick] = text;
  renderBoard();
  showToast('Added to card!');
}

function addCustomToPool() {
  const input = document.getElementById('customPoolInput');
  const val = input.value.trim();
  if (!val) return;
  customPool.push(val);
  localStorage.setItem('f1bingo_custompool', JSON.stringify(customPool));
  input.value = '';
  renderPool();
  showToast('Added to pool!');
}

function removeCustom(idx, e) {
  e.stopPropagation();
  customPool.splice(idx, 1);
  localStorage.setItem('f1bingo_custompool', JSON.stringify(customPool));
  renderPool();
}

// =====================
//   CARDS GALLERY
// =====================

function renderCardsGallery() {
  const cards = JSON.parse(localStorage.getItem('f1bingo_cards') || '[]');
  const grid = document.getElementById('cardsGrid');
  if (cards.length === 0) {
    grid.innerHTML = '<div class="empty-state">No saved cards yet.<br>Save a card from the Play tab!</div>';
    return;
  }
  grid.innerHTML = '';
  cards.forEach(card => {
    const el = document.createElement('div');
    el.className = 'saved-card';
    const date = new Date(card.savedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const marked = new Set(card.marked || []);
    const free = new Set(card.freeIdx || [12]);
    const previewCells = card.squares.map((_,i) => {
      const cls = free.has(i) ? 'preview-cell pf' : marked.has(i) ? 'preview-cell pm' : 'preview-cell';
      return `<div class="${cls}"></div>`;
    }).join('');

    el.innerHTML = `
      <div class="saved-card-name">${card.name}</div>
      <div class="saved-card-meta">Saved ${date} ¬∑ ${marked.size} marked</div>
      <div class="saved-card-preview">${previewCells}</div>
      <div class="saved-card-btns">
        <button class="sc-btn sc-btn-load" onclick="loadSavedCard('${card.id}')">Play</button>
        <button class="sc-btn sc-btn-share" onclick="shareSavedCard('${card.id}')">Share</button>
        <button class="sc-btn sc-btn-del" onclick="deleteCard('${card.id}')">Delete</button>
      </div>
    `;
    grid.appendChild(el);
  });
}

function loadSavedCard(id) {
  const cards = JSON.parse(localStorage.getItem('f1bingo_cards') || '[]');
  const card = cards.find(c => c.id === id);
  if (!card) return;
  currentSquares = card.squares;
  freeIdx = card.freeIdx || [12];
  markedCells = new Set(card.marked || []);
  document.getElementById('cardName').value = card.name;
  switchViewDirect('play');
  renderBoard();
}

function shareSavedCard(id) {
  const cards = JSON.parse(localStorage.getItem('f1bingo_cards') || '[]');
  const card = cards.find(c => c.id === id);
  if (!card) return;
  const payload = { name: card.name, squares: card.squares, freeIdx: card.freeIdx || [12] };
  const encoded = btoa(JSON.stringify(payload));
  const url = `${window.location.origin}${window.location.pathname}#card=${encoded}`;
  navigator.clipboard.writeText(url).then(() => showToast('üîó Link copied!')).catch(() => prompt('Copy:', url));
}

function deleteCard(id) {
  let cards = JSON.parse(localStorage.getItem('f1bingo_cards') || '[]');
  cards = cards.filter(c => c.id !== id);
  localStorage.setItem('f1bingo_cards', JSON.stringify(cards));
  renderCardsGallery();
}

function switchViewDirect(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  document.querySelector(`.nav-tab:nth-child(${name==='play'?1:2})`).classList.add('active');
}

// =====================
//   UTILS
// =====================

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function launchConfetti() {
  const wrap = document.getElementById('confettiWrap');
  wrap.innerHTML = '';
  const colors = ['#E8002D','#FFD700','#fff','#00C851','#0066ff','#ff6600'];
  for (let i=0;i<80;i++) {
    const p = document.createElement('div');
    p.className = 'cp';
    const sz = Math.random()*10+4;
    p.style.cssText = `left:${Math.random()*100}%;width:${sz}px;height:${sz}px;background:${colors[Math.floor(Math.random()*colors.length)]};border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${Math.random()*2+2}s;animation-delay:${Math.random()*.5}s;opacity:${Math.random()*.5+.5};`;
    wrap.appendChild(p);
  }
  setTimeout(() => wrap.innerHTML = '', 4000);
}
</script>
</body>
</html>
